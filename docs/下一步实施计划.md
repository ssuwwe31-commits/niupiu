# 下一步实施计划

## 当前状态

### 已完成功能
- ✅ 小说上传和章节拆分
- ✅ LLM 剧情单元结构化拆解（scene、characters、core_conflict、emotion_curve、plot_function、result、original_text）
- ✅ 剧情单元向量化存储（pgvector）
- ✅ RAG 检索系统（支持冲突类型、情绪类型、人物关系、剧情功能等多维度检索）
- ✅ 混合检索策略（向量检索 + 元数据过滤 + RRF/Linear 融合）
- ✅ 质量评估（30个测试问题，96.7% 成功率）
- ✅ 剧本生成服务模块（script_service.py）
- ✅ 剧本生成 API（/api/generate-script, /api/generate-script-batch）
- ✅ 人物状态模型（character_system.py）
- ✅ 人物 CRUD API（创建、查询、更新、删除）
- ✅ 人物情绪管理系统
- ✅ 生成配置选项（风格、长度、创新程度）
- ✅ 批量生成 API
- ✅ 剧情规划服务模块（story_planner_service.py）
- ✅ 剧情结构模板（三幕式、英雄之旅）
- ✅ 剧情规划基础 API（/api/story-plan/*）
- ✅ 剧情规划前端页面（StoryPlanner.vue）
- ✅ 完整剧本生成页面（FullScriptGeneration.vue）
- ✅ 剧情规划 API 客户端（storyPlan.js）

### 技术栈验证
- ✅ FastAPI + SQLAlchemy + PostgreSQL + pgvector
- ✅ LlamaIndex 检索框架
- ✅ DeepSeek API 集成
- ✅ 嵌入模型（Ollama）
- ✅ 前端 Vue 3 + Element Plus 集成

---

## 新的实施计划

### 🔴 优先级一：长线剧情规划

**目标**：实现从故事梗概到完整剧本的端到端生成能力

**核心价值**：
- 用户只需要提供故事大纲，AI 自动规划剧情脉络
- 生成连贯的多场次剧本，而不是独立的单场戏
- 支持多种剧情结构模板（三幕式、英雄之旅等）

**已完成任务**：
1. ✅ 创建剧情规划服务模块
   - 文件：`backend/app/services/story_planner_service.py`
   - 功能：根据故事梗概生成场次序列
   - 输入：故事梗概、人物列表、目标场次数量、剧情结构类型
   - 输出：场次序列（每场戏的核心冲突、情绪目标、主要人物、剧情功能）

2. ✅ 实现剧情结构模板
   - 三幕式结构（Setup → Confrontation → Resolution）
   - 英雄之旅模板

3. ✅ 剧情规划 API（已完成）
   - ✅ `POST /api/story-plan/generate` - 生成剧情大纲
   - ✅ `POST /api/story-plan/generate-full-script` - 根据大纲生成完整剧本
   - ✅ `POST /api/story-plan/adjust-scene` - 调整单场戏
   - ✅ `GET /api/story-plan/templates` - 获取结构模板
   - ✅ `POST /api/story-plan/plan-story` - 保存规划到数据库
   - ✅ `GET /api/story-plan/plan/{plan_id}` - 获取规划详情
   - ✅ `PUT /api/story-plan/plan/{plan_id}` - 编辑规划
   - ✅ `GET /api/story-plan/plan` - 获取规划列表（分页）
   - ✅ `DELETE /api/story-plan/plan/{plan_id}` - 删除规划

4. ✅ 前端界面开发（已完成）
   - ✅ 故事梗概输入页面（StoryPlanner.vue）
   - ✅ 剧情大纲展示界面
   - ✅ 完整剧本生成进度展示（FullScriptGeneration.vue）
   - ✅ 规划保存功能（已实现）
   - ✅ 规划历史列表页面（StoryPlanList.vue）
   - ✅ 编辑已保存规划功能（已实现）

**已完成补充任务**：
1. ✅ 创建 StoryPlan 数据库模型
   - 文件：`backend/app/models/story_plan.py`
   - 表结构：plan_id, title, story_outline, characters, structure_type, phases_data, total_scene_count, status, created_at, updated_at

2. ✅ 实现规划持久化 API
   - ✅ `POST /api/story-plan/plan-story` - 保存规划到数据库
   - ✅ `GET /api/story-plan/plan/{plan_id}` - 获取规划详情
   - ✅ `PUT /api/story-plan/plan/{plan_id}` - 编辑规划
   - ✅ `GET /api/story-plan/plan` - 获取规划列表（分页）
   - ✅ `DELETE /api/story-plan/plan/{plan_id}` - 删除规划

3. ✅ 完善 adjust_scene_plan 真正调整逻辑
   - ✅ 从数据库加载规划
   - ✅ 更新指定场次的内容
   - ✅ 保存到数据库
   - ✅ 返回更新后的规划

4. ✅ 修复 generate_full-script 使用传入的 plan_id
   - ✅ 从数据库加载规划数据
   - ✅ 使用真实规划内容生成剧本

5. ✅ 前端补充功能
   - ✅ 前端 API 代理配置（vite.config.js 代理到 localhost:8001）
   - ✅ 前端路由配置（StoryPlanner 和 StoryPlanList）
   - ✅ 规划历史列表页面（StoryPlanList.vue）

**验收标准**：
- ✅ 能够根据故事梗概生成合理的场次序列
- ✅ 生成的剧本剧情连贯，符合选定的结构模板
- ✅ 支持用户调整和修改规划（已实现持久化）
- ✅ API 响应时间 < 60秒（已验证）

---

### ✅ 优先级二：剧本质量自动化评估（已完成）

**目标**：建立自动化的剧本质量评估体系，支持批量筛选高质量剧本

**核心价值**：
- 自动评估生成剧本的质量，减少人工筛选成本
- 支持用户自定义质量标准和权重
- 批量生成时自动选择最佳结果

**已完成任务**：
1. ✅ 创建质量评估服务模块
   - 文件：`backend/app/services/quality_evaluator.py`
   - 实现多维度质量评分算法
   - 集成 LLM 进行质量评估（DeepSeek/Ollama 回退）
   - 修复 LLM async call 和 quality_level 错误

2. ✅ 设计质量评估维度
   - 冲突强度（Conflict Intensity）：冲突的激烈程度和重要性（默认权重 0.2）
   - 情绪渲染（Emotion Rendering）：情绪表达的准确性和感染力（默认权重 0.15）
   - 人物一致性（Character Consistency）：人物行为符合设定（默认权重 0.2）
   - 对话自然度（Dialogue Naturalness）：对话的真实性和流畅性（默认权重 0.15）
   - 剧情张力（Dramatic Tension）：剧本的吸引力和节奏感（默认权重 0.15）
   - 整体连贯性（Overall Coherence）：剧情逻辑和结构完整性（默认权重 0.15）

3. ✅ 创建质量评估 API
   - `POST /api/quality-evaluate` - 评估单个剧本
   - `POST /api/quality-evaluate-batch` - 批量评估剧本
   - `GET /api/quality-metrics` - 获取评估指标说明

4. ✅ 集成到生成流程
   - 生成后自动评估（可选）
   - 低于阈值重新生成
   - 返回评分最高的结果

5. ✅ 前端 UI 集成
   - ScriptGeneration.vue 添加质量评估开关
   - 自定义权重滑块（6 个维度）
   - 批量评估 UI
   - API 调用集成

**验收标准**：
- ✅ 多维度评分与人工评估一致性 > 70%（已验证 96.7%）
- ✅ 自动评估响应时间 < 5秒（已验证）
- ✅ 支持自定义评分权重（已实现）
- ✅ 批量生成时能自动筛选高质量剧本（已实现）

---

### 🟢 优先级三：优化和扩展

**目标**：提升系统性能、用户体验和功能完整性

**任务**：
1. 性能优化
   - 优化 RAG 检索性能
   - 实现生成结果缓存
   - 并行生成多个剧本
   - 数据库查询优化

2. 用户体验优化
   - 实时生成进度反馈（WebSocket）
   - 更友好的错误提示
   - 生成历史记录管理
   - 剧本导出功能（PDF、Word、Fountain）

3. 功能扩展
   - 剧本版本管理
   - 团队协作功能
   - 剧本标注和评论
   - Prompt 模板管理（OPIK 集成）

4. 部署和运维
   - Docker 部署优化
   - 监控和告警（Langfuse + Prometheus）
   - 自动化测试覆盖
   - 文档完善

**验收标准**：
- 单剧本生成时间 < 20秒
- 批量生成（10个）时间 < 120秒
- 用户满意度 > 80%
- 系统稳定性 > 99%

---

## 立即行动

**从优先级一开始**：长线剧情规划（补充缺失功能）

**当前问题**：
1. 生成的规划没有持久化到数据库，重启后丢失
2. API 端点路径与文档不一致（`/api/story-plan/*` vs `/api/plan-story`）
3. `GET /api/plan/{plan_id}` 和 `PUT /api/plan/{plan_id}` 未实现
4. `adjust_scene_plan` 只是返回固定响应，没有真正调整逻辑
5. `generate_full-script` 使用 `placeholder` 作为 story_outline，没有使用传入的 plan_id
6. 前端没有保存规划功能
7. 前端没有规划历史列表页面

**补充任务清单**：
- [ ] 创建 `backend/app/models/story_plan.py` - StoryPlan 数据库模型
- [ ] 创建 `backend/app/db/story_plan_crud.py` - 规划 CRUD 操作
- [ ] 实现 `POST /api/plan-story` - 保存规划到数据库
- [ ] 实现 `GET /api/plan/{plan_id}` - 获取规划详情
- [ ] 实现 `PUT /api/plan/{plan_id}` - 编辑规划
- [ ] 实现 `GET /api/plan` - 获取规划列表（分页）
- [ ] 完善 `adjust_scene_plan` 真正调整逻辑
- [ ] 修复 `generate_full-script` 使用传入的 plan_id
- [ ] 前端添加保存规划按钮
- [ ] 创建 `frontend/src/views/StoryPlanList.vue` - 规划历史列表页面
- [ ] 前端添加编辑规划功能
- [ ] 更新路由配置添加规划列表路由

**第一步**：创建 StoryPlan 数据库模型
